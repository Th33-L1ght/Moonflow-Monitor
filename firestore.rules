
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Allow users to manage their own profiles (and their children's)
    match /children/{childId} {
      // CREATE: A user can create a profile if they are the parent.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.parentUid;

      // READ: A user can read a profile if they are the parent OR the linked child.
      allow read: if request.auth != null && (request.auth.uid == resource.data.parentUid || request.auth.uid == resource.data.childUid);
      
      // UPDATE: A user can update a profile if they are the parent OR the linked child.
      allow update: if request.auth != null && (request.auth.uid == resource.data.parentUid || request.auth.uid == resource.data.childUid);
      
      // DELETE: A user can delete a profile only if they are the parent and no child is linked.
      allow delete: if request.auth != null && request.auth.uid == resource.data.parentUid && resource.data.childUid == null;
    }
    
    // Allow users to manage their own invites
    match /invites/{inviteId} {
      // CREATE: The parent who owns the child profile can create an invite.
      allow create: if request.auth != null && get(/databases/$(database)/documents/children/$(request.resource.data.childId)).data.parentUid == request.auth.uid;
      
      // READ: The parent can read the invite to get info.
      allow read: if request.auth != null && request.auth.uid == resource.data.parentUid;
      
      // UPDATE: A newly authenticated user can accept an invite.
      allow update: if request.auth != null && request.resource.data.status == 'accepted';
      
      // No one can delete invites for now to prevent race conditions. They are single-use.
      allow delete: if false;
    }

    // Allow users to submit feedback
    match /feedback/{feedbackId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read, write: if false; // Only allow creation
    }
  }
}
